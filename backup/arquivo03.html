<!-- üîß Scripts -->
<script>
  let inatividadeTimer;
  let sessaoAtiva = false;
  let slimSelectInstance = null;

  function resetarTimer() {
    if (!sessaoAtiva) return;
    clearTimeout(inatividadeTimer);
    inatividadeTimer = setTimeout(() => {
      deslogar();
      document.getElementById('mensagem-chave').textContent = "‚è± Sess√£o expirada por inatividade. Por favor, insira a chave novamente.";
      document.getElementById('mensagem-chave').style.color = "orange";
    }, 10 * 60 * 1000);
  }

  function iniciarMonitoramentoInatividade() {
    ['mousemove', 'keydown', 'scroll'].forEach(evt =>
      document.addEventListener(evt, resetarTimer)
    );
    document.addEventListener('click', e => {
      if (e.target.id !== 'enviar') resetarTimer();
    });
  }

  iniciarMonitoramentoInatividade();

  async function enviarFormulario(event) {
    event.preventDefault();

    if (!validarCamposSelecionados()) return;

    const spinner = document.getElementById('spinner');
    spinner.style.display = "inline-block";

    const form = document.getElementById('formulario');
    const formData = new FormData(form);
    formData.delete('senha');

    const containerAnalise = document.getElementById('analise');
    marcarUltimaAnalise();

    const carregandoExistente = document.getElementById('carregando-analise');
    if (carregandoExistente) carregandoExistente.remove();

    const carregando = document.createElement('div');
    carregando.id = "carregando-analise";
    carregando.textContent = "Processando...";
    carregando.style.marginBottom = "12px";
    containerAnalise.prepend(carregando);

    try {
      const resposta = await fetch('https://learningbyworking.app.n8n.cloud/webhook-test/Agente-gpt', {
        method: 'POST',
        body: formData
      });

      const json = await resposta.json();

      if (json.grafico_isolado_base64) {
        const novoGrafico = `
          <div class="grafico-isolado" style="margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid #ddd;">
            <img src="data:image/png;base64,${json.grafico_isolado_base64}" style="max-width: 100%; border-radius: 6px;" alt="Gr√°fico isolado" />
          </div>
        `;
        const containerGrafico = document.getElementById('grafico');
        containerGrafico.insertAdjacentHTML('afterbegin', novoGrafico);
      }

      if (json.analise && json.analise.trim() !== "") {
        const carregandoAntigo = document.getElementById('carregando-analise');
        if (carregandoAntigo) carregandoAntigo.remove();

        const parteAnalise = json.analise
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br>');

        const novaAnalise = `
          <div class="analise-completa" style="margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid #ccc;">
            <div class="analise-texto">${parteAnalise}</div>
            ${json.grafico_base64 ? `<div class="analise-graficos"><img src="data:image/png;base64,${json.grafico_base64}" alt="Gr√°fico da an√°lise" style="margin-top: 12px;" /></div>` : ""}
          </div>
        `;
        containerAnalise.insertAdjacentHTML('afterbegin', novaAnalise);
      }

    } catch (error) {
      const erroMsg = document.createElement('div');
      erroMsg.style.color = 'red';
      erroMsg.style.marginBottom = '12px';
      erroMsg.textContent = `‚ùå Erro ao processar resposta: ${error.message}`;
      containerAnalise.insertBefore(erroMsg, containerAnalise.firstChild);
    } finally {
      spinner.style.display = "none";
    }
  }

  // üß† Bot√£o ‚ÄúPerguntar‚Äù envia pergunta ao Agente com base na √∫ltima an√°lise
  async function perguntarIA() {
    const pergunta = document.getElementById("prompt").value.trim();
    if (!pergunta) return;

    const ultima = document.querySelector(".analise-completa");
    if (!ultima) {
      alert("‚ö†Ô∏è Nenhuma an√°lise encontrada.");
      return;
    }

    const textoHTML = ultima.querySelector(".analise-texto")?.innerHTML || "";
    const textoPlano = textoHTML
      .replace(/<br\s*\/?>/gi, "\n")
      .replace(/<\/?[^>]+(>|$)/g, "")
      .trim();

    const promptCompleto = `Com base nesta an√°lise:\n\n${textoPlano}\n\nResponda √† pergunta:\n\n${pergunta}`;

    const containerAnalise = document.getElementById("analise");
    const blocoPergunta = document.createElement("div");
    blocoPergunta.className = "pergunta-resposta";
    blocoPergunta.style.marginBottom = "24px";
    blocoPergunta.style.border = "1px dashed #007bff";
    blocoPergunta.style.padding = "12px";
    blocoPergunta.style.backgroundColor = "#f8faff";

    blocoPergunta.innerHTML = `<strong>Pergunta:</strong> ${pergunta}<br><em>Carregando resposta...</em>`;
    containerAnalise.prepend(blocoPergunta);

    try {
      const resposta = await fetch("https://learningbyworking.app.n8n.cloud/webhook-test/Agente-gpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: promptCompleto })
      });

      const json = await resposta.json();
      const respostaIA = json?.analise || "‚ùå N√£o foi poss√≠vel obter resposta.";
      blocoPergunta.innerHTML = `<strong>Pergunta:</strong> ${pergunta}<br><strong>Resposta:</strong> ${respostaIA.replace(/\n/g, "<br>")}`;
    } catch (erro) {
      blocoPergunta.innerHTML = `<strong>Pergunta:</strong> ${pergunta}<br><span style="color:red;">‚ùå Erro: ${erro.message}</span>`;
    }
  }
</script>

